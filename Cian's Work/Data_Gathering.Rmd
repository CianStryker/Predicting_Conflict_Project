---
title: "Data Gathering"
author: "Cian Stryker"
date: "10/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(WDI)
library(countrycode)
library(readr)
library(openxlsx)
library(janitor)
library(naniar)
library(data.table)

```

```{r Gathering Wold Bank Data, eval=FALSE}

# new_cache = WDIcache()

# WDIsearch('CC BY-4.0')

World_Bank_Data <- WDI(indicator = c("gdp_current_US" = "NY.GDP.MKTP.CD",
                                     "gdp_per_capita" = "NY.GDP.PCAP.CD",
                                     "population" = "SP.POP.TOTL",
                                     "population_growth_rate" = "SP.POP.GROW",
                                     "infant_mortality" = "SH.DTH.IMRT",
                                     "unemployment" = "SL.UEM.TOTL.NE.ZS",
                                     "percent_male_population" = "SP.POP.TOTL.MA.ZS",
                                     "oil_rent_percent_gdp" = "NY.GDP.PETR.RT.ZS",
                                     "natural_gas_percent_gdp" = "NY.GDP.NGAS.RT.ZS", 
                                     "mineral_rent_percent_gdp" = "NY.GDP.MINR.RT.ZS", 
                                     "natual_resources_rent_percent_gdp" = "NY.GDP.TOTL.RT.ZS"), 
                       country = "all", start = 1960, extra = FALSE)

WB_original_countries <- data.frame(unique(World_Bank_Data$country))

World_Bank_Data$country <- countrycode(World_Bank_Data$country, "country.name", "country.name")


Data_Set <- World_Bank_Data %>%
  filter(country != "NA")

Data_Set$continent = Data_Set$country

Data_Set$continent <- countrycode(Data_Set$country, "country.name", "continent")

Data_Set <- Data_Set %>%
  select(country, iso2c, year, continent, everything())


write.xlsx(Data_Set, "Raw_Data/First_Draft_Data.xlsx")

```

```{r Loading in Data}

# It takes way less time to load in data from the excel file
# than in takes to create the data directly from the World Bank

Data_Set <- read.xlsx("Raw_Data/First_Draft_Data.xlsx") 

Data_Set$year <- as.factor(Data_Set$year)
```

```{r HDI Data}

hdi_data <- read_csv("Raw_Data/Human Development Index (HDI).csv", col_types = cols(
                                                                    .default = col_character(),
                                                                    `HDI Rank (2018)` = col_double()
                      ))

hdi_data <- hdi_data[,-1]

hdi_data2 <- reshape2::melt(hdi_data, measure.vars = 2:30) %>%
  clean_names()

colnames(hdi_data2)[colnames(hdi_data2) == 'variable'] <- "year"
colnames(hdi_data2)[colnames(hdi_data2) == 'value'] <- "hdi"

hdi_data2$country <- countrycode(hdi_data2$country, "country.name", "country.name") 

hdi_data2 <- hdi_data2 %>%
  filter(country != "NA") 

hdi_data2 <- hdi_data2 %>%
  replace_with_na(replace = list(hdi = c("..")))

Data_Set2 <- left_join(Data_Set, hdi_data2, by = c("country", "year"))
```

```{r Military Expenditure Data}

# Military Sepnding in terms of Current USD (in Millions) 

military_spending <- read.xlsx("Raw_Data/SIPRI-Milex-data-1949-2019.xlsx")

military_spending2 <- reshape2::melt(military_spending, measure.vars = 2:72)%>%
  clean_names()

colnames(military_spending2)[colnames(military_spending2) == 'variable'] <- "year"
colnames(military_spending2)[colnames(military_spending2) == 'value'] <- "military_spending"

military_spending2 <- military_spending2 %>%
  replace_with_na(replace = list(military_spending = c("xxx", ". ."))) 

# military_spending2$country <- countrycode(military_spending2$country, "country.name", "country.name") 

# military_spending2 <- military_spending2 %>%
#   filter(country != "NA") 

Data_Set3 <- left_join(Data_Set2, military_spending2, by = c("country", "year")) 

Data_Set3$military_spending <- as.numeric(Data_Set3$military_spending)

Data_Set3 <- Data_Set3%>%
  mutate(military_spending = military_spending * 1000000)
```

```{r Military Import Data}

military_imports <- read_csv("Raw_Data/TIV-Import-All-1950-2019.csv", col_types = cols(
  .default = col_double(),
  country = col_character()
))

military_imports2 <- reshape2::melt(military_imports, measure.vars = 2:72)%>%
  clean_names()

colnames(military_imports2)[colnames(military_imports2) == 'variable'] <- "year"
colnames(military_imports2)[colnames(military_imports2) == 'value'] <- "military_imports_TIV"

# military_imports2$country <- countrycode(military_imports2$country, "country.name", "country.name") 

# military_imports3 <- military_imports2 %>%
#   filter(country != "NA")

Data_Set4 <- left_join(Data_Set3, military_imports2, by = c("country", "year"))
```


```{r Freedom House}

# Freedom house is red as higher equals less free. 

freedom_house <- read.xlsx("Raw_Data/FOTP1980-FOTP2017_Public-Data.xlsx")

freedom_house <- reshape2::melt(freedom_house, measure.vars = 2:25)%>%
  clean_names()

colnames(freedom_house)[colnames(freedom_house) == 'variable'] <- "year"
colnames(freedom_house)[colnames(freedom_house) == 'value'] <- "freedom_index"

# Freedom house is giving scores to "Serbia and Montenegro" which was a country
# that did not exist yet. I'm giving those values to Yugoslavia instead. 

freedom_house <- freedom_house %>%
  replace_with_na(replace = list(freedom_index = c("-"))) %>%
  filter(country != "Yugoslavia")

freedom_house[freedom_house == "Serbia and Montenegro"] <- "Yugoslavia"

Data_Set5 <- left_join(Data_Set4, freedom_house, by = c("country", "year")) %>%
  filter(year != 2020)

```

```{r Making More Excel Data}

write.xlsx(Data_Set5, "Raw_Data/Second_Draft_Data.xlsx")

```

```{r Ethnic Diveristy}

# I'm using the Historical Index of Ethnic Fractionalizaiton dataset.

HIEF <- read_csv("Raw_Data/HIEF_data.csv", col_types = cols(
  Country = col_character(),
  Year = col_double(),
  EFindex = col_double()
))

# So this dataset differentiated between North and South Vietnam
# but since we're merging them elsewhere, I removed South Vietnam
# and kept North Vietnam for our Vietnam data. 

HIEF <- HIEF %>%
  filter(Year >= 1960) %>%
  mutate(Year = as.factor(Year)) %>%
  filter(Country != "Republic of Vietnam")

HIEF[HIEF == "Democratic Republic of Vietnam"] <- "Vietnam"


colnames(HIEF)[colnames(HIEF) == 'Country'] <- "country"
colnames(HIEF)[colnames(HIEF) == 'Year'] <- "year"

HIEF$country <- countrycode(HIEF$country, "country.name", "country.name") 

HIEF <- HIEF %>%
  drop_na(country) %>%
  group_by(country, year) %>%
  unique()

countrylist <- unique(Data_Set5$country)

Data_Set6 <- left_join(Data_Set5 %>% group_by(country) %>% mutate(id = row_number()),
                  HIEF %>% group_by(country) %>% mutate(id = row_number()), 
                  by = c("country", "year", "id")) %>%
              select(-id)

year_range <- unique(Data_Set5$year)

```

```{r Peacekeeping Data}

Peace <- read_csv("Raw_Data/MILINDA-v1-March2019.csv", col_types = cols(
  .default = col_character(),
  caseid = col_double(),
  hcons = col_double(),
  yearbeg = col_double(),
  yearbeg_n = col_double(),
  duram_n = col_double(),
  person_n = col_double(),
  status_n2 = col_double(),
  ch7_n = col_double(),
  srcadis = col_double(),
  srcadis_n = col_double(),
  srctpi = col_double(),
  srctpi_n = col_double(),
  srcsipr_n = col_double(),
  bef1992a = col_double()
))

Peace <- Peace %>%
  select(country, yearbeg, yearend)

Peace$yearend[Peace$yearend == "ongoing"] <- 2018

end_year <- parse_number(Peace$yearend)

Peace2 <- data.frame(Peace, end_year) %>%
    select(!yearend)

Peace2$yearbeg <- as.double(Peace2$yearbeg)
Peace2$end_year <- as.double(Peace2$end_year)

Peace2 <- Peace2 %>%
  filter(yearbeg >= 1960)

write.xlsx(Peace2, "Raw_Data/Manual_time.xlsx")

Peace_Changed <- read.xlsx("Raw_Data/Manual_time_changed.xlsx")

Peace3 <- setDT(Peace_Changed)[, .(country, year = seq(yearbeg, end_year, by = 1)), 
          .(grp = 1:nrow(Peace_Changed))][, grp := NULL][] %>%
  mutate(year = as.factor(year))

countries_Peace <- unique(Peace3$country)

list1 <- nrow(Peace3)
peace_keeping <- rep(1, length(list1))

Peace3 <- data.frame(Peace3, peace_keeping)

year <- rep(year_range, length(countries_Peace))
country <- rep(countries_Peace, length(year_range))


Peace_Data <- data.frame(year)
Peace_Data2 <- tibble(country) %>%
  arrange(country)

Peace_Data3 <- data.frame(Peace_Data2, Peace_Data)

Peace_Data3[Peace_Data3 == "Western Sahara Morocco"] <- "Morocco"


Peace4 <- left_join(Peace_Data3, Peace3, by = c("country", "year")) 

Peace4$country <- countrycode(Peace4$country, "country.name", "country.name") 

Peace4 <- Peace4 %>%
  drop_na(country) %>%
  group_by(country, year) %>%
  unique()

Peace4[is.na(Peace4)] <- 0

Data_Set7 <- left_join(Data_Set6 %>% group_by(country) %>% mutate(id = row_number()),
                  Peace4 %>% group_by(country) %>% mutate(id = row_number()), 
                  by = c("country", "year", "id")) %>%
              select(-id)

```

```{r Newest Version}

write.xlsx(Data_Set7, "Raw_Data/Third_Draft.xlsx")

```

```{r All predictors data, eval=FALSE}

All_p_Data <- read_csv("Raw_Data/fourth_final.csv", col_types = cols(
  .default = col_double(),
  country = col_character(),
  iso2c = col_character(),
  continent = col_character()
))


All_p_Data$peace_keeping[is.na(All_p_Data$peace_keeping)] <- 0

```

