---
title: "Modeling"
author: "Liz Masten"
date: "11/9/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(randomForest)
library(missForest)
library(fastDummies)
library(tidyverse)
```

```{r}

data <- read_csv("Raw_Data_Liz/Final_Data.csv", col_types = cols(
  .default = col_double(),
  country = col_character(),
  iso2c = col_character(),
  continent = col_character()
))

data <- as.data.frame(data) 

```

```{r}

# create authority_challenge variable from ranges in change outside of -20:20 

data$change <- as.factor(data$change)

data_2 <- data %>% 
          mutate(authority_challenge = recode_factor(change, 
                                                     "-66" = "1",
                                                     "-77" = "1",
                                                     "0" = "1", 
                                                     "88" = "1",
                                                     "-88" = "1",
                                                     "96" = "1",
                                                     "97" = "1",
                                                     "98" = "1", 
                                                     "99" = "1")) 

data_2$authority_challenge <- ifelse(data_2$authority_challenge =="1", 1, 0)

# clean up change column to take out values now represented in authority_challenge 

data_3 <- data_2 %>% 
          mutate(change = recode_factor(change,
                                      "-66" = "NA",
                                      "-77" = "NA",
                                      "0" = "NA", 
                                      "88" = "NA",
                                      "-88" = "NA",
                                      "96" = "NA",
                                      "97" = "NA",
                                      "98" = "NA", 
                                      "99" = "NA"))



```


```{r}

# remove :SF (now represented in authority_challenge)
        #fragment (not coded before 2000)
        #iso2c (represented in country and annoying for imputation)
        #regtrans (now represented in authority_challenge)
        #

data_3 <- data_3 %>% 
          select(-iso2c, -sf, -fragment, -regtrans)

```



```{r}

data_3$change <- as.numeric(data_3$change)

data_3$continent <- as.factor(data_3$continent)

data_3$peace_keeping <- as.factor(data_3$peace_keeping)

data_3$change <- as.integer(data_3$change)

data_3$durable <- as.integer(data_3$durable)

data_3$terrorism_kill <- as.integer(data_3$terrorism_kill)

data_3$terrorism_wound <- as.integer(data_3$terrorism_wound)

data_3$state_target <- as.integer(data_3$state_target)

data_3$nonstate_target <- as.integer(data_3$nonstate_target)

data_3$authority_challenge <- as.factor(data_3$authority_challenge)

data_3$xrreg <- as.factor(data_3$xrreg)

data_3$xrcomp <- as.factor(data_3$xrcomp)

data_3$xropen <- as.factor(data_3$xropen)

data_3$parreg <- as.factor(data_3$parreg)

data_3$parcomp <- as.factor(data_3$parcomp)

data_3$xconst <- as.factor(data_3$xconst)

data_3$polity2 <- as.factor(data_3$polity2)

data_3$n_conflict <- as.numeric(data_3$n_conflict)


```

```{r}

# see what's missing: 

p_missing <- unlist(lapply(data_3, function(x) sum(is.na(x))))/nrow(data_3)

sort(p_missing[p_missing > 0], decreasing = TRUE)

# almost half of our variables are missing > 50% of their observations... 

```


```{r, cache=TRUE}

#Impute

set.seed(2020)

dummy_data <- data_3 %>% 
              dummy_cols(select_columns = c("country"),
                        remove_selected_columns = TRUE)

imp_mf <- missForest(dummy_data, variablewise = TRUE, verbose = TRUE, ntree = 100) 

# OOB imputation error est: 

imp_mf$OOBerror

# here's the data frame


imp_df <- imp_mf$ximp

imputed_data <- write_csv(imp_df, path = "Raw_Data_Liz/imputed_data.csv")

```


```{r}

rfd <- read_csv("Raw_Data_Liz/imputed_data.csv", col_types = cols(
  .default = col_double(),
  continent = col_character()
))

#split data

set.seed(2020)

test <- sample(seq(nrow(rfd)), 
                          round(0.2 * nrow(rfd)))

training <- which(!(seq(nrow(rfd)) %in% test))

test_data <- data.frame(data[test, ])

training_data <- data.frame(data[training, ])

# random forest can't run chr variables 

rfd$continent <- as.factor(rfd$continent)

```


```{r, cache = TRUE}

# random forest

# mtry is defaulted at sqrt of p 

set.seed(2020)

bag_rfd <- randomForest(n_conflict ~ ., data=data.frame(rfd[-test,]),
                              importance =TRUE)

bag_rfd$importance

```

```{r}
  
# predict: 
  
rfd.test <- rfd[-training ,"n_conflict"]


yhat.bag <- predict (bag_rfd, newdata=rfd[-training ,])

mean((yhat.bag -rfd.test)^2)

```

